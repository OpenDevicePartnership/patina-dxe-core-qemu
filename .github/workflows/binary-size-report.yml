# @file binary-size-check.yml
#
# GitHub Actions workflow to compare QEMU Patina DXE Core binary sizes for PRs.
#
# This workflow runs in an untrusted PR context to build the code on a fork and upload
# the size data as an artifact. When it is complete, a separate workflow (binary-size-comment.yml)
# operates exclusively on the size data artifact and posts the comment.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0

name: Binary Size Report

on:
  pull_request:

jobs:
  run:
    name: Binary Size Report
    runs-on: ubuntu-latest
    steps:

      - name: âœ… Checkout Base Branch (${{ github.base_ref }}) âœ…
        uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: ðŸ› ï¸ Download Rust Tools Base Branch (${{ github.base_ref }}) ðŸ› ï¸
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Build Base Branch (${{ github.base_ref }})
        run: |
          cargo make q35
          cargo make ovmf
          cargo make sbsa
          cargo make q35-release
          cargo make ovmf-release
          cargo make sbsa-release

      - name: Get Base Branch (${{ github.base_ref }}) Sizes
        id: size-base
        shell: bash
        run: |
          get_size() { python3 -c "import os; print(os.path.getsize('$1'))"; }
          echo "q35_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "q35_release=$(get_size target/x86_64-unknown-uefi/release/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "ovmf_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_ovmf_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "ovmf_release=$(get_size target/x86_64-unknown-uefi/release/qemu_ovmf_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_debug=$(get_size target/aarch64-unknown-uefi/debug/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_release=$(get_size target/aarch64-unknown-uefi/release/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT

      - name: âœ… Checkout PR Branch (${{ github.head_ref }}) âœ…
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ› ï¸ Download Rust Tools PR Branch (${{ github.head_ref }}) ðŸ› ï¸
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Build PR Branch (${{ github.head_ref }})
        run: |
          cargo make q35
          cargo make ovmf
          cargo make sbsa
          cargo make q35-release
          cargo make ovmf-release
          cargo make sbsa-release

      - name: Get PR Branch (${{ github.head_ref }}) Sizes
        id: size-pr
        shell: bash
        run: |
          get_size() { python3 -c "import os; print(os.path.getsize('$1'))"; }
          echo "q35_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "q35_release=$(get_size target/x86_64-unknown-uefi/release/qemu_q35_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "ovmf_debug=$(get_size target/x86_64-unknown-uefi/debug/qemu_ovmf_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "ovmf_release=$(get_size target/x86_64-unknown-uefi/release/qemu_ovmf_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_debug=$(get_size target/aarch64-unknown-uefi/debug/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT
          echo "aarch64_release=$(get_size target/aarch64-unknown-uefi/release/qemu_sbsa_dxe_core.efi)" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Binary Size Report
        shell: bash
        run: |
          REPORT_FILE="$GITHUB_WORKSPACE/binary_size_report.md"

          pretty_size() {
            local bytes=$1
            local sign=""
            if (( bytes < 0 )); then sign="-"; bytes=$(( -bytes )); fi
            awk -v b="$bytes" -v s="$sign" 'BEGIN {
              if (b < 1024) { printf "%s%.2f B ", s, b }
              else if (b < 1024*1024) { printf "%s%.2f KB", s, b/1024 }
              else { printf "%s%.2f MB", s, b/(1024*1024) }
            }'
          }

          SHA1="${{ github.base_ref }}"
          SHA2="${{ github.head_ref }}"

          Q35_SHA1_DEBUG_SIZE=${{ steps.size-base.outputs.q35_debug }}
          Q35_SHA2_DEBUG_SIZE=${{ steps.size-pr.outputs.q35_debug }}
          Q35_DEBUG_DIFF=$((Q35_SHA2_DEBUG_SIZE - Q35_SHA1_DEBUG_SIZE))
          Q35_DEBUG_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$Q35_SHA1_DEBUG_SIZE")" \
            "$(pretty_size "$Q35_SHA2_DEBUG_SIZE")" \
            "$(pretty_size "$Q35_DEBUG_DIFF")")"

          Q35_SHA1_RELEASE_SIZE=${{ steps.size-base.outputs.q35_release }}
          Q35_SHA2_RELEASE_SIZE=${{ steps.size-pr.outputs.q35_release }}
          Q35_RELEASE_DIFF=$((Q35_SHA2_RELEASE_SIZE - Q35_SHA1_RELEASE_SIZE))
          Q35_RELEASE_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$Q35_SHA1_RELEASE_SIZE")" \
            "$(pretty_size "$Q35_SHA2_RELEASE_SIZE")" \
            "$(pretty_size "$Q35_RELEASE_DIFF")")"

          OVMF_SHA1_DEBUG_SIZE=${{ steps.size-base.outputs.ovmf_debug }}
          OVMF_SHA2_DEBUG_SIZE=${{ steps.size-pr.outputs.ovmf_debug }}
          OVMF_DEBUG_DIFF=$((OVMF_SHA2_DEBUG_SIZE - OVMF_SHA1_DEBUG_SIZE))
          OVMF_DEBUG_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$OVMF_SHA1_DEBUG_SIZE")" \
            "$(pretty_size "$OVMF_SHA2_DEBUG_SIZE")" \
            "$(pretty_size "$OVMF_DEBUG_DIFF")")"

          OVMF_SHA1_RELEASE_SIZE=${{ steps.size-base.outputs.ovmf_release }}
          OVMF_SHA2_RELEASE_SIZE=${{ steps.size-pr.outputs.ovmf_release }}
          OVMF_RELEASE_DIFF=$((OVMF_SHA2_RELEASE_SIZE - OVMF_SHA1_RELEASE_SIZE))
          OVMF_RELEASE_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$OVMF_SHA1_RELEASE_SIZE")" \
            "$(pretty_size "$OVMF_SHA2_RELEASE_SIZE")" \
            "$(pretty_size "$OVMF_RELEASE_DIFF")")"

          AARCH64_SHA1_DEBUG_SIZE=${{ steps.size-base.outputs.aarch64_debug }}
          AARCH64_SHA2_DEBUG_SIZE=${{ steps.size-pr.outputs.aarch64_debug }}
          AARCH64_DEBUG_DIFF=$((AARCH64_SHA2_DEBUG_SIZE - AARCH64_SHA1_DEBUG_SIZE))
          AARCH64_DEBUG_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$AARCH64_SHA1_DEBUG_SIZE")" \
            "$(pretty_size "$AARCH64_SHA2_DEBUG_SIZE")" \
            "$(pretty_size "$AARCH64_DEBUG_DIFF")")"

          AARCH64_SHA1_RELEASE_SIZE=${{ steps.size-base.outputs.aarch64_release }}
          AARCH64_SHA2_RELEASE_SIZE=${{ steps.size-pr.outputs.aarch64_release }}
          AARCH64_RELEASE_DIFF=$((AARCH64_SHA2_RELEASE_SIZE - AARCH64_SHA1_RELEASE_SIZE))
          AARCH64_RELEASE_DIFF_COLUMN="$(printf '`%11s`<br>`%11s`<br>**`Î” %9s`**' \
            "$(pretty_size "$AARCH64_SHA1_RELEASE_SIZE")" \
            "$(pretty_size "$AARCH64_SHA2_RELEASE_SIZE")" \
            "$(pretty_size "$AARCH64_RELEASE_DIFF")")"

          echo "### Binary Size Report" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "| Platform       | Commit                                       | Î” Debug Size               | Î” Release Size               |" >> "$REPORT_FILE"
          echo "|----------------|----------------------------------------------|----------------------------|------------------------------|" >> "$REPORT_FILE"
          echo "| Q35 (x86_64)   | Base:\`${SHA1}\`<br>PR:\`${SHA2}\`<br>&nbsp; | $Q35_DEBUG_DIFF_COLUMN     | $Q35_RELEASE_DIFF_COLUMN     |" >> "$REPORT_FILE"
          echo "| OVMF (x86_64)  | Base:\`${SHA1}\`<br>PR:\`${SHA2}\`<br>&nbsp; | $OVMF_DEBUG_DIFF_COLUMN    | $OVMF_RELEASE_DIFF_COLUMN    |" >> "$REPORT_FILE"
          echo "| SBSA (aarch64) | Base:\`${SHA1}\`<br>PR:\`${SHA2}\`<br>&nbsp; | $AARCH64_DEBUG_DIFF_COLUMN | $AARCH64_RELEASE_DIFF_COLUMN |" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"

      - name: ðŸ“ Save PR Metadata and Report
        shell: bash
        run: |
          mkdir -p pr-data
          echo "${{ github.event.pull_request.number }}" > pr-data/pr_number.txt
          echo "${{ github.base_ref }}" > pr-data/base_ref.txt
          echo "${{ github.head_ref }}" > pr-data/head_ref.txt
          cp "$GITHUB_WORKSPACE/binary_size_report.md" pr-data/

      - name: ðŸ“¤ Upload PR Data and Report
        uses: actions/upload-artifact@v7
        with:
          name: binary-size-report-data
          path: pr-data/
          retention-days: 1
